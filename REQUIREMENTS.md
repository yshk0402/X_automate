# X自動投稿スケジューラ（自分用）— REQUIREMENTS.md（ドラフト）

> 注意：本ドキュメントはドラフトです。未確定事項は `{{TODO: 未確定}}` として残します。

## 1. 背景・目的

* X（旧Twitter）への手動投稿の手間を減らし、**日時指定の予約投稿**を自前で運用したい。
* 予約投稿の全体像を**カレンダービュー（月＋週）**で視覚的に把握したい（「いつ・何本・何を」）。
* **読み取りAPIなし**でも運用事故（特に二重投稿）を防ぐ。

## 2. 成功指標

* 予約作成 → 自動投稿 → ログ確認までが1人で回る
* 二重投稿ゼロ
* UIで予約の見通しが即座に把握できる

## 3. スコープ

### In scope（MVP）

* Xへのテキスト投稿を日時指定で自動実行
* 予約投稿の作成・編集・キャンセル（物理削除しない）
* カレンダービュー：**月表示（必須）＋週表示（実装）**
* 投稿キュー管理（状態、ログ、失敗の手動再実行）
* 管理画面（GAS Webアプリ）
* failed発生時のメール通知（スパム防止を考慮）

### Out of scope（初期）

* X APIの読み取り（投稿取得・タイムライン表示など）
* 画像/動画投稿
* リプライ/スレッド自動生成
* 複数アカウント運用
* AI生成・RSS自動取り込み

## 4. 前提・制約

* 実装基盤：Google Apps Script（GAS）
* データストア：Googleスプレッドシート
* UI：GAS Webアプリ（HTMLService）
* 認証：X API（ユーザーとして投稿できるOAuthフロー）

  * 認証方式の最終決定：OAuth 1.0a
  * X APIのアクセスレベル：Free想定（ただし変更され得る）
* 予約時刻はJST（+0900）で統一
* トリガー：GAS時間トリガー（秒精度は保証しない）
* トリガー間隔：5分
* 予約の最小粒度：5分単位OK
* **過去日時の予約は不可**（UIで弾く）

## 5. 利用者・権限

* 利用者：管理者（=自分）1名
* Webアプリへのアクセス：自分のGoogleアカウントのみ

## 6. 主要ユースケース

1. 予約を作る：日時＋投稿文を入力し、`queued` で登録
2. 予約を把握：カレンダー（月/週）で日別件数と内容を把握
3. 予約を編集：`queued` のみ編集可
4. 予約をキャンセル：削除ではなく `canceled` へ
5. 自動投稿：時刻到達で投稿し `posted` へ（tweet_id保存）
6. 失敗対応：`failed` を確認し、原因を見て**手動で `queued` に戻して再実行**

## 7. 機能要件

### 7.1 予約管理

* 予約作成

  * 入力：`scheduled_at`（JST）、`text`（本文）
  * 追加時：`status=queued`
  * バリデーション：空文字禁止、日時必須、**過去日時はエラー**
* 予約編集

  * `status=queued` のみ編集可
  * `posting/posted` は編集不可
* 予約キャンセル

  * 物理削除しない
  * `status=canceled` に遷移
* 予約複製：{{TODO: MVPに入れる/次フェーズか決定}}

### 7.2 自動投稿（スケジューラ）

* 定期実行（時間トリガー）
* 対象抽出：`status=queued` かつ `scheduled_at <= now`
* 1回の実行で処理する件数：**最大1件**（安定運用優先）
* 排他制御：LockServiceで多重実行を防止
* 状態遷移

  * `queued → posting`（APIコール前に確定）
  * 成功：`posting → posted`（`tweet_id`, `posted_at` 保存）
  * 失敗：`posting → failed`（`error`, `last_attempt_at` 保存）
* リトライ方針

  * **自動リトライしない**
  * 再実行は管理画面で `failed → queued` に戻す
* 二重投稿防止

  * ロック + 先に `posting` へ遷移 + 1件処理
  * `posting` が残留した場合の復旧：管理画面で解除（`posting → failed` など）

### 7.3 UI：カレンダー（最重要）

* ライブラリ：**FullCalendar（Standard/MIT想定）**
* 表示モード：月（必須）、週（実装）
* セル内表示

  * 日別の予約件数
  * 本文先頭N文字（タイトル代わり）
  * ステータス色分け（queued/posted/failed/canceled）
* インタラクション（MVP）

  * 日付クリック：その日の詳細リスト（右ペイン or モーダル）
  * 予約クリック：詳細編集モーダル
* ドラッグ&ドロップ：MVPで入れる（週/月内の日時変更）
* 検索/フィルタ：{{TODO: MVPで入れる/最小はフィルタのみ等}}

### 7.4 一覧・運用画面（最低限）

* 予約一覧（テーブル）

  * 日時、本文先頭、status、操作（編集/キャンセル/再実行）
* 失敗一覧（failedのみ）

  * error内容、最終実行時刻、再実行（queuedへ戻す）

### 7.5 通知

* `failed` 発生時にメール通知
* スパム防止：同一idの連続通知抑制（30分以内は抑制）

## 8. データ要件（スプレッドシート）

### 8.1 Postsシート

* `id`（UUID）
* `scheduled_at`（Date or ISO文字列）
* `text`
* `status`（queued/posting/posted/failed/canceled）
* `created_at` / `updated_at`
* `posted_at`
* `tweet_id`
* `error`
* `last_attempt_at`（任意）
* `attempt_count`（任意）

### 8.2 監査ログ（任意）

* 実行ログを別シートに記録（いつ何を投稿しようとしてどうなったか）

## 9. 非機能要件

* 信頼性：二重投稿防止最優先
* パフォーマンス：月表示で最大数百件を想定、一覧はバッチ取得
* セキュリティ

  * Xトークン/シークレットは Script Properties 等へ保存
  * Webアプリは自分のみ
  * ログは最小化（本文を必要以上に残さない）

## 10. 受け入れ基準（Acceptance Criteria）

* 予約が作成でき、カレンダー（月/週）に反映される
* `queued` のみ編集・キャンセルできる
* 指定時刻以降に自動投稿され `posted` になり `tweet_id` が保存される
* 失敗時に `failed` となり `error` が確認できる
* failed時にメール通知される（抑制あり）
* 二重投稿が起きない
